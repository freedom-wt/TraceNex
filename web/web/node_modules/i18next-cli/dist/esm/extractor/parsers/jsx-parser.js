import{getObjectProperty as e,getObjectPropValue as t,isSimpleTemplateLiteral as n}from"./ast-utils.js";function i(e){if(e)return"StringLiteral"===e.type?e.value:"TemplateLiteral"===e.type&&n(e)?e.quasis[0].cooked:void 0}function r(e){return"StringLiteral"===e.value?.type?e.value.value:"JSXExpressionContainer"===e.value?.type?i(e.value.expression):void 0}function s(n,s){const o=n.opening.attributes?.find(e=>"JSXAttribute"===e.type&&"Identifier"===e.name.type&&"i18nKey"===e.name.value),p=n.opening.attributes?.find(e=>"JSXAttribute"===e.type&&"Identifier"===e.name.type&&"defaults"===e.name.value),l=n.opening.attributes?.find(e=>"JSXAttribute"===e.type&&"Identifier"===e.name.type&&"count"===e.name.value),a=n.opening.attributes?.find(e=>"JSXAttribute"===e.type&&"Identifier"===e.name.type&&"values"===e.name.value);let u;l||"JSXAttribute"!==a?.type||"JSXExpressionContainer"!==a.value?.type||"ObjectExpression"!==a.value.expression.type||(u=e(a.value.expression,"count"));const y=!!l||!!u,f=n.opening.attributes?.find(e=>"JSXAttribute"===e.type&&"Identifier"===e.name.type&&"tOptions"===e.name.value),c="JSXAttribute"===f?.type&&"JSXExpressionContainer"===f.value?.type&&"ObjectExpression"===f.value.expression.type?f.value.expression:void 0,v=n.opening.attributes?.find(e=>"JSXAttribute"===e.type&&"Identifier"===e.name.type&&"ordinal"===e.name.value),S=!!v,d=n.opening.attributes?.find(e=>"JSXAttribute"===e.type&&"Identifier"===e.name.type&&"context"===e.name.value);let g="JSXAttribute"===d?.type&&"JSXExpressionContainer"===d.value?.type?d.value.expression:"JSXAttribute"===d?.type&&"StringLiteral"===d.value?.type?d.value:void 0;const x=n.opening.attributes?.find(e=>"JSXAttribute"===e.type&&"Identifier"===e.name.type&&"ns"===e.name.value);let m;if(m="JSXAttribute"===x?.type?r(x):void 0,c&&(void 0===m&&(m=t(c,"ns")),void 0===g)){const t=e(c,"context");t?.value&&(g=t.value)}const J=function(e,t){if(!e||0===e.length)return"";const n=new Set(t.extract.transKeepBasicHtmlNodesFor??["br","strong","i","p"]),r=e=>e&&"JSXText"===e.type&&/^\s*$/.test(e.value)&&e.value.includes("\n");function s(e,t,o=!1){if(!e||!e.length)return;let p=0,l=e.length-1;for(;p<=l&&r(e[p]);)p++;for(;l>=p&&r(e[l]);)l--;const a=p<=l?e.slice(p,l+1):[],u=a.some(e=>e&&("JSXElement"===e.type||"JSXFragment"===e.type));for(let e=0;e<a.length;e++){const p=a[e];if(p)if("JSXText"!==p.type){if("JSXExpressionContainer"===p.type){if(o&&!u&&p.expression){const e=p.expression.type;if("ObjectExpression"===e){const e=p.expression.properties&&p.expression.properties[0];if(e&&"KeyValueProperty"===e.type)continue}const t=i(p.expression);if(void 0!==t){if(!(/^\s*$/.test(t)&&!t.includes("\n")))continue}else if("Identifier"===e||"MemberExpression"===e||"CallExpression"===e)continue}const n=i(p.expression);if(void 0!==n){const i=/^\s*$/.test(n)&&!n.includes("\n"),s=a[e-1],o=a[e+1];if(i){const n=a[e+2];if(o&&"JSXText"===o.type&&r(o)&&n&&("JSXElement"===n.type||"JSXFragment"===n.type)){const t=a[e-1],n=a[e-2];if(!t||"JSXText"!==t.type&&n&&"JSXExpressionContainer"===n.type)continue}if(s&&("JSXElement"===s.type||"JSXFragment"===s.type)&&o&&"JSXText"===o.type&&r(o))continue;const i=!o||"JSXText"===o.type&&!r(o);if(s&&"JSXText"===s.type&&i){const e=t[t.length-1];if(e&&"JSXText"===e.type){e.value=String(e.value)+p.expression.value;continue}}if(s&&("JSXElement"===s.type||"JSXFragment"===s.type)&&o&&"JSXText"===o.type&&r(o))continue}}t.push(p);continue}if("JSXElement"===p.type){const e=p.opening&&p.opening.name&&"Identifier"===p.opening.name.type?p.opening.name.value:void 0;if(e&&n.has(e)){!(!p.opening||!p.opening.selfClosing)&&t.push(p),s(p.children||[],t,!1)}else t.push(p),s(p.children||[],t,!0);continue}"JSXFragment"!==p.type||s(p.children||[],t,o)}else{if(o&&!u)continue;if(o&&r(p))continue;if(r(p)){const n=a[e-1],i=a[e+1];if(n&&("JSXElement"===n.type||"JSXFragment"===n.type)&&i&&("JSXElement"===i.type||"JSXFragment"===i.type))continue;const r=t[t.length-1],s=a[e-1];if(r){if(s&&"JSXExpressionContainer"===s.type)continue;if("JSXText"===r.type&&s&&"JSXText"===s.type){r.value=String(r.value)+p.value;continue}}}if(o&&u&&0===e)continue;t.push(p)}}}const o=[];s(e,o,!1);const p=e=>String(e).replace(/^\s*\n\s*/g,"").replace(/\s*\n\s*$/g,"");function l(e,t){if(!e||0===e.length)return"";let s="",a=!1;for(let u=0;u<e.length;u++){const y=e[u];if(y)if("JSXText"!==y.type){if("JSXExpressionContainer"===y.type){const e=y.expression;if(!e)continue;const t=i(e);if(void 0!==t)s+=t;else if("Identifier"===e.type)s+=`{{${e.value}}}`;else if("ObjectExpression"===e.type){const t=e.properties[0];t&&"KeyValueProperty"===t.type&&t.key&&"Identifier"===t.key.type?s+=`{{${t.key.value}}}`:t&&"Identifier"===t.type?s+=`{{${t.value}}}`:s+="{{value}}"}else"MemberExpression"===e.type&&e.property&&"Identifier"===e.property.type?s+=`{{${e.property.value}}}`:"CallExpression"===e.type&&"Identifier"===e.callee?.type?s+=`{{${e.callee.value}}}`:s+="{{value}}";a=!1;continue}if("JSXElement"===y.type){let i;if(y.opening&&y.opening.name&&"Identifier"===y.opening.name.type&&(i=y.opening.name.value),i&&n.has(i)){const n=l(y.children||[],t),r=!(!y.opening||!y.opening.selfClosing),o=""!==String(n).trim();if(r||!o){const t=e[u-1];t&&"JSXText"===t.type&&/\n\s*$/.test(t.value)&&(s=s.replace(/\s+$/,"")),s+=`<${i}/>`,a=!0}else s+=`<${i}>${n}</${i}>`,a=!1}else{const e=y.children||[];if(e.some(e=>e&&("JSXText"===e.type||"JSXExpressionContainer"===e.type)&&-1!==o.indexOf(e))){const t=o.indexOf(y),n=l(e,void 0);s+=`<${t}>${p(n)}</${t}>`,a=!1}else{const i=new Map;let r=0;for(const t of e)if(t&&"JSXElement"===t.type){const e=t.opening&&t.opening.name&&"Identifier"===t.opening.name.type?t.opening.name.value:void 0;if(e&&n.has(e)){!(!t.opening||!t.opening.selfClosing)&&i.set(t,r++)}else i.set(t,r++)}const u=t&&t.has(y)?t.get(y):o.indexOf(y),f=l(e,i.size?i:void 0);s+=`<${u}>${p(f)}</${u}>`,a=!1}}continue}"JSXFragment"!==y.type||(s+=l(y.children||[]),a=!1)}else{if(r(y))continue;a?(s+=y.value.replace(/^\s+/,""),a=!1):s+=y.value}}return s}const a=l(e);return String(a).replace(/\s+/g," ").trim()}(n.children,s);let X;const E="JSXAttribute"===p?.type?r(p):void 0;if(void 0!==E)X=E;else{const e=s.extract.defaultValue;X="string"==typeof e?e:""}let b,h;if("JSXAttribute"===o?.type){if("StringLiteral"===o.value?.type){if(b=o.value,h=b.value,!h||""===h.trim())return null;if(m&&"StringLiteral"===b.type){const e=s.extract.nsSeparator??":",t=b.value;if(e&&t.startsWith(`${m}${e}`)){if(h=t.slice(`${m}${e}`.length),!h||""===h.trim())return null;b={...b,value:h}}}}else"JSXExpressionContainer"===o.value?.type&&"JSXEmptyExpression"!==o.value.expression.type&&(b=o.value.expression);if(!b)return null}p||!h||J.trim()?!p&&J.trim()&&(X=J):X=h;return{keyExpression:b,serializedChildren:J,ns:m,defaultValue:X,hasCount:y,isOrdinal:S,contextExpression:g,optionsNode:c,explicitDefault:void 0!==E||(e=>{if(!e||!Array.isArray(e.properties))return!1;for(const t of e.properties)if(t&&"KeyValueProperty"===t.type&&t.key){const e="Identifier"===t.key.type&&t.key.value||"StringLiteral"===t.key.type&&t.key.value;if("string"==typeof e&&e.startsWith("defaultValue"))return!0}return!1})(c)}}export{s as extractFromTransComponent};
