import{glob as e}from"glob";import{readFile as t}from"node:fs/promises";import{parse as n}from"@swc/core";import r from"chalk";import o from"ora";async function s(s){const i=o("Analyzing source files...\n").start();try{const o=["node_modules/**"],l=Array.isArray(s.extract.ignore)?s.extract.ignore:s.extract.ignore?[s.extract.ignore]:[],c=await e(s.extract.input,{ignore:[...o,...l]});let f=0;const u=new Map;for(const e of c){const r=await t(e,"utf-8"),o=a(await n(r,{syntax:"typescript",tsx:!0,decorators:!0}),r,s);o.length>0&&(f+=o.length,u.set(e,o))}if(f>0){i.fail(r.red.bold(`Linter found ${f} potential issues.`));for(const[e,t]of u.entries())console.log(r.yellow(`\n${e}`)),t.forEach(({text:e,line:t})=>{console.log(`  ${r.gray(`${t}:`)} ${r.red("Error:")} Found hardcoded string: "${e}"`)});process.exit(1)}else i.succeed(r.green.bold("No issues found."))}catch(e){i.fail(r.red("Linter failed to run.")),console.error(e),process.exit(1)}}const i=e=>/^(https|http|\/\/|^\/)/.test(e);function a(e,t,n){const r=[],o=[],s=e=>t.substring(0,e).split("\n").length,a=n.extract.transComponents||["Trans"],l=n.extract.ignoredTags||[],c=new Set([...a,"script","style","code",...l]),f=n.extract.ignoredAttributes||[],u=new Set(["className","key","id","style","href","i18nKey","defaults","type","target",...f]),p=e=>{if(!e)return null;const t=e.name??e.opening?.name??e.opening?.name;if(!t)return e.opening?.name?p({name:e.opening.name}):null;const n=e=>{if(!e)return null;if("JSXIdentifier"===e.type&&(e.name||e.value))return e.name??e.value;if("Identifier"===e.type&&(e.name||e.value))return e.name??e.value;if("JSXMemberExpression"===e.type){const t=n(e.object),r=n(e.property);return t&&r?`${t}.${r}`:r??t}return e.name??e.value??e.property?.name??e.property?.value??null};return n(t)},m=e=>{for(let t=e.length-1;t>=0;t--){const n=e[t];if(n&&"object"==typeof n&&("JSXElement"===n.type||"JSXOpeningElement"===n.type||"JSXSelfClosingElement"===n.type)){const e=p(n);if(e&&c.has(e))return!0}}return!1},y=(e,t)=>{if(!e||"object"!=typeof e)return;const n=[...t,e];if("JSXText"===e.type){if(!m(n)){const t=e.value.trim();t&&t.length>1&&"..."!==t&&!i(t)&&isNaN(Number(t))&&!t.startsWith("{{")&&o.push(e)}}if("StringLiteral"===e.type){const t=n[n.length-2],r=m(n);if("JSXAttribute"===t?.type&&!u.has(t.name.value)&&!r){const t=e.value.trim();t&&"..."!==t&&!i(t)&&isNaN(Number(t))&&o.push(e)}}for(const t of Object.keys(e)){if("span"===t)continue;const r=e[t];Array.isArray(r)?r.forEach(e=>y(e,n)):r&&"object"==typeof r&&y(r,n)}};y(e,[]);let g=0;for(const e of o){const n=e.raw??e.value,o=t.indexOf(n,g);o>-1&&(r.push({text:e.value.trim(),line:s(o)}),g=o+n.length)}return r}export{s as runLinter};
