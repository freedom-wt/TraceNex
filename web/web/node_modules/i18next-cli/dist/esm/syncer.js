import o from"chalk";import{glob as t}from"glob";import{mkdir as e,writeFile as n}from"node:fs/promises";import{basename as r,resolve as i,dirname as a}from"node:path";import l from"ora";import{resolveDefaultValue as s}from"./utils/default-value.js";import{getOutputPath as c,loadTranslationFile as f,serializeTranslationFile as u}from"./utils/file-utils.js";import{shouldShowFunnel as m,recordFunnelShown as y}from"./utils/funnel-msg-tracker.js";import{getNestedKeys as p,getNestedValue as d,setNestedValue as g}from"./utils/nested-object.js";async function h(h){const w=l("Running i18next locale synchronizer...\n").start();try{const l=h.extract.primaryLanguage||h.locales[0]||"en",S=h.locales.filter(o=>o!==l),{output:$,keySeparator:x=".",outputFormat:b="json",indentation:j=2,defaultValue:z=""}=h.extract,v=[];let N=!1;const k=c($,l,"*"),A=await t(k);if(0===A.length)return void w.warn(`No translation files found for primary language "${l}". Nothing to sync.`);for(const t of A){const l=r(t).split(".")[0],m=await f(t);if(!m){v.push(`  ${o.yellow("-")} Could not read primary file: ${t}`);continue}const y=p(m,x??".");for(const t of S){const r=c($,t,l),p=i(process.cwd(),r),h=await f(p)||{},w={};for(const o of y){const e=d(m,o,x??"."),n=d(h,o,x??".")??s(z,o,l,t,e);g(w,o,n,x??".")}const S=JSON.stringify(h);if(JSON.stringify(w)!==S){N=!0;const t=u(w,b,j);await e(a(p),{recursive:!0}),await n(p,t),v.push(`  ${o.green("âœ“")} Synchronized: ${r}`)}else v.push(`  ${o.gray("-")} Already in sync: ${r}`)}}w.succeed(o.bold("Synchronization complete!")),v.forEach(o=>console.log(o)),N?await async function(){if(!await m("syncer"))return;return console.log(o.green.bold("\nâœ… Sync complete.")),console.log(o.yellow("ðŸš€ Ready to collaborate with translators? Move your files to the cloud.")),console.log(`   Get started with the official TMS for i18next: ${o.cyan("npx i18next-cli locize-migrate")}`),y("syncer")}():console.log(o.green.bold("\nâœ… All locales are already in sync."))}catch(t){w.fail(o.red("Synchronization failed.")),console.error(t)}}export{h as runSyncer};
