import t from"ora";import a from"chalk";import{parse as e}from"@swc/core";import{mkdir as o,writeFile as r,readFile as n}from"node:fs/promises";import{dirname as i}from"node:path";import{findKeys as s}from"./key-finder.js";import{getTranslations as c}from"./translation-manager.js";import{validateExtractorConfig as l,ExtractorError as m}from"../../utils/validation.js";import{extractKeysFromComments as u}from"../parsers/comment-parser.js";import{ConsoleLogger as f}from"../../utils/logger.js";import{serializeTranslationFile as p}from"../../utils/file-utils.js";import{shouldShowFunnel as y,recordFunnelShown as g}from"../../utils/funnel-msg-tracker.js";async function d(e,{isWatchMode:n=!1,isDryRun:m=!1,syncPrimaryWithDefaults:u=!1}={},d=new f){e.extract.primaryLanguage||=e.locales[0]||"en",e.extract.secondaryLanguages||=e.locales.filter(t=>t!==e?.extract?.primaryLanguage),e.extract.functions||=["t","*.t"],e.extract.transComponents||=["Trans"],l(e);const w=e.plugins||[],x=t("Running i18next key extractor...\n").start();try{const{allKeys:t,objectKeys:n}=await s(e,d);x.text=`Found ${t.size} unique keys. Updating translation files...`;const l=await c(t,n,e,{syncPrimaryWithDefaults:u});let f=!1;for(const t of l)if(t.updated&&(f=!0,!m)){const n=p(t.newTranslations,e.extract.outputFormat,e.extract.indentation);await o(i(t.path),{recursive:!0}),await r(t.path,n),d.info(a.green(`Updated: ${t.path}`))}if(w.length>0){x.text="Running post-extraction plugins...";for(const t of w)await(t.afterSync?.(l,e))}return x.succeed(a.bold("Extraction complete!")),f&&await async function(){if(!await y("extract"))return;return console.log(a.yellow.bold("\nðŸ’¡ Tip: Tired of running the extractor manually?")),console.log('   Discover a real-time "push" workflow with `saveMissing` and Locize AI,'),console.log("   where keys are created and translated automatically as you code."),console.log(`   Learn more: ${a.cyan("https://www.locize.com/blog/i18next-savemissing-ai-automation")}`),console.log(`   Watch the video: ${a.cyan("https://youtu.be/joPsZghT3wM")}`),g("extract")}(),f}catch(t){throw x.fail(a.red("Extraction failed.")),t}}async function w(t,a,o,r,i,s=new f){try{let c=await n(t,"utf-8");for(const e of a)try{const a=await(e.onLoad?.(c,t));void 0!==a&&(c=a)}catch(t){s.warn(`Plugin ${e.name} onLoad failed:`,t)}const l=await e(c,{syntax:"typescript",tsx:!0,decorators:!0,comments:!0});r.getVarFromScope=o.getVarFromScope.bind(o),o.visit(l),u(c,r,i,o.getVarFromScope.bind(o))}catch(a){throw new m("Failed to process file",t,a)}}async function x(t,{syncPrimaryWithDefaults:a=!1}={}){t.extract.primaryLanguage||=t.locales[0]||"en",t.extract.secondaryLanguages||=t.locales.filter(a=>a!==t?.extract?.primaryLanguage),t.extract.functions||=["t","*.t"],t.extract.transComponents||=["Trans"];const{allKeys:e,objectKeys:o}=await s(t);return c(e,o,t,{syncPrimaryWithDefaults:a})}export{x as extract,w as processFile,d as runExtractor};
